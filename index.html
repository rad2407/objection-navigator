<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Objection Navigator — Real Estate Closings</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://objectionsiq.com/wp-content/uploads/2025/08/cropped-objectionsiq-favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://objectionsiq.com/wp-content/uploads/2025/08/cropped-objectionsiq-favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://objectionsiq.com/wp-content/uploads/2025/08/cropped-objectionsiq-favicon.png">
  <link rel="apple-touch-icon" href="https://objectionsiq.com/wp-content/uploads/2025/08/cropped-objectionsiq-favicon.png">
  <meta name="theme-color" content="#0f172a">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
    (function () {
      const t = localStorage.getItem('theme');
      const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (t === 'dark' || (!t && prefers)) document.documentElement.classList.add('dark');
    })();
  </script>

  <!-- React 18 UMD + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html { scroll-behavior: smooth; }
    .prose pre { white-space: pre-wrap; }
  </style>
</head>

<!-- Firebase Auth + Firestore -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider,
    signInWithPopup, signInWithRedirect, getRedirectResult,
    onAuthStateChanged, signOut, setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, serverTimestamp,
    collection, addDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyADjPLowBKNwx8r1RnMsv_asaF6dwuJ4OE",
    authDomain: "objection-navigator-app.firebaseapp.com",
    projectId: "objection-navigator-app",
    storageBucket: "objection-navigator-app.appspot.com",
    messagingSenderId: "85639282737",
    appId: "1:85639282737:web:8343f7a0684e6637189510",
    measurementId: "G-J5JWXKVGH4"
  };

  const app = initializeApp(firebaseConfig);

  const auth = getAuth(app);
  auth.languageCode = "en";
  await setPersistence(auth, browserLocalPersistence);

  const provider = new GoogleAuthProvider();
  provider.setCustomParameters({ prompt: "select_account" });

  async function signIn() {
    try { await signInWithPopup(auth, provider); }
    catch { try { await signInWithRedirect(auth, provider); } catch (e) { alert("Sign in error, " + e.message); console.error(e); } }
  }
  async function signOutSafe() {
    try {
      await signOut(auth);
      localStorage.removeItem('dfs_objections_v4');
      localStorage.removeItem('dfs_categories_v1');
    } catch (e) { console.error(e); }
  }
  getRedirectResult(auth).catch(e => { alert("Redirect sign in error, " + e.message); console.error(e); });

  const db = getFirestore(app);

  async function saveToCloud(uid, data, categories) {
    if (!uid) return;
    const ref = doc(db, "users", uid);
    await setDoc(ref, { data, categories, updatedAt: serverTimestamp() }, { merge: true });
  }
  async function loadFromCloud(uid) {
    if (!uid) return null;
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    return snap.exists() ? snap.data() : null;
  }

  async function createSharedFromApp(data, categories) {
    const ref = await addDoc(collection(db, "shared"), { data, categories, createdAt: serverTimestamp() });
    return ref.id;
  }
  async function loadSharedDoc(id) {
    const ref = doc(db, "shared", id);
    const snap = await getDoc(ref);
    return snap.exists() ? snap.data() : null;
  }

  function getUTM() {
    const p = new URLSearchParams(location.search);
    return {
      source: p.get('utm_source') || null,
      medium: p.get('utm_medium') || null,
      campaign: p.get('utm_campaign') || null,
      content: p.get('utm_content') || null,
      term: p.get('utm_term') || null,
      ref: p.get('ref') || null,
    };
  }
  async function createLeadIfNew(user, utm) {
    if (!user) return;
    try {
      const ref = doc(db, "leads", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, {
          uid: user.uid,
          email: user.email || null,
          name: user.displayName || null,
          utm: utm || {},
          createdAt: serverTimestamp(),
        });
      }
    } catch (e) { console.error("lead create failed", e); }
  }

  window.saveToCloud = saveToCloud;
  window.loadFromCloud = loadFromCloud;
  window.getUID = () => auth.currentUser?.uid || null;
  window.signIn = signIn;
  window.signOutSafe = signOutSafe;
  window.createSharedFromApp = createSharedFromApp;
  window.loadSharedDoc = loadSharedDoc;
  window.getUTM = getUTM;
  window.createLeadIfNew = createLeadIfNew;

  onAuthStateChanged(auth, async user => {
    const nameEl = document.getElementById("user-name");
    const inBtn = document.getElementById("btn-sign-in");
    const outBtn = document.getElementById("btn-sign-out");
    if (user) {
      nameEl && (nameEl.textContent = user.displayName || user.email || "");
      inBtn && inBtn.classList.add("hidden");
      outBtn && outBtn.classList.remove("hidden");
      try { await createLeadIfNew(user, getUTM()); } catch (e) { console.error(e); }
    } else {
      nameEl && (nameEl.textContent = "");
      inBtn && inBtn.classList.remove("hidden");
      outBtn && outBtn.classList.add("hidden");
    }
    window.dispatchEvent(new CustomEvent("auth-changed", { detail: { uid: user?.uid || null } }));
  });

  window.dispatchEvent(new Event("firebase-ready"));
  window.addEventListener("unhandledrejection", e => console.error(e.reason));
  window.addEventListener("error", e => console.error(e.error || e.message));
</script>

<body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const LS_DATA = 'dfs_objections_v4';
    const LS_CATS = 'dfs_categories_v1';
    const LS_KEY_LEGACY = 'dfs_objections_v3';

    const L_FLOW = 'dfs_flow_v1';
    const L_START = 'dfs_start_v1';

    const CATEGORY_BADGES = {
      'Price & Money': 'bg-rose-100 text-rose-800 border-rose-200 dark:bg-rose-900/30 dark:text-rose-200 dark:border-rose-800',
      'Value / Belief': 'bg-sky-100 text-sky-800 border-sky-200 dark:bg-sky-900/30 dark:text-sky-200 dark:border-sky-800',
      'Timing': 'bg-amber-100 text-amber-800 border-amber-200 dark:bg-amber-900/30 dark:text-amber-200 dark:border-amber-800',
      'Trust / Proof': 'bg-emerald-100 text-emerald-800 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-200 dark:border-emerald-800',
      'Competition / Alternatives': 'bg-violet-100 text-violet-800 border-violet-200 dark:bg-violet-900/30 dark:text-violet-200 dark:border-violet-800',
      'Decision-Making': 'bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-900/30 dark:text-orange-200 dark:border-orange-800',
    };

    const DEFAULT_CATS = [
      'Price & Money','Value / Belief','Timing',
      'Trust / Proof','Competition / Alternatives','Decision-Making',
    ];

    // 30 defaults, same as your file
    const DEFAULT_DATA = [/* your 30 entries unchanged, kept verbatim */ 
      { id: 1, category: 'Price & Money', objection: 'I can get a website for $500.', acknowledge: 'You totally can — and honestly, if a website is all you’re looking for, then $500 is the right move.', differentiate: 'We’re not selling a website though. We’re building a system designed to help you generate and close more deals — website, CRM, ads, automation, and nurturing all working together.', anchor: 'One closing can be worth $10K. If this system brings in even one more deal all year, you’re already at a 4x ROI.', close: 'So is the goal just to have a site, or to have a system that actually brings you closings?' },
      { id: 2, category: 'Price & Money', objection: 'I want to wait until I close more deals.', acknowledge: 'Totally get it — cash flow timing is real in this business.', differentiate: 'But the system we’re offering is designed to help you get those closings, not wait on them.', anchor: 'You’re sitting on $10K+ per deal. If this gets you even one deal sooner, it pays for itself 4x over.', close: 'Do you want to keep waiting for deals to come in, or start pulling them in consistently?' },
      { id: 3, category: 'Price & Money', objection: 'This sounds expensive.', acknowledge: 'It is more than a basic site, for sure.', differentiate: 'But this isn’t a brochure site — it’s a full lead engine with automation and nurturing designed to convert strangers into closings.', anchor: 'Zillow charges $2K+ per month for shared leads. One deal here covers you for the year, and it’s exclusive.', close: 'Would you rather pay less and get zero clients, or pay more and have a system that brings in real deals?' },
      { id: 4, category: 'Value / Belief', objection: 'I’ve tried marketing before, it didn’t work.', acknowledge: 'You’re not alone — a lot of agents waste money on bad marketing.', differentiate: 'The difference here is we’re not doing one-off ads. We’ve built a system that follows up, nurtures, and converts leads automatically.', anchor: 'Most agents don’t lose because of lack of leads — they lose because they can’t convert them. That’s what we fix.', close: 'So are you done trying, or are you ready to try something that’s actually built to work?' },
      { id: 5, category: 'Timing', objection: 'I don’t have time right now.', acknowledge: 'Makes sense — you’re probably juggling listings, showings, clients, all of it.', differentiate: 'But this is built specifically for agents with no time. We automate the lead follow up so you don’t have to.', anchor: 'How much time do you spend chasing dead leads now? One closing from this system saves you weeks of busywork — and adds $10K to your bank account.', close: 'So do you want to keep wasting time on the wrong prospects, or free up your time by letting the system do the chasing for you?' },
      { id: 6, category: 'Decision-Making', objection: 'I need to think about it.', acknowledge: 'Totally — you should never rush into a decision without being confident.', differentiate: 'But ‘thinking about it’ usually just means ‘I’m not sure it’ll work.’ What if we built the whole thing around making sure it does?', anchor: 'We’ve already helped agents go from zero pipeline to 3–5 closings a month using the same system. That’s $30K–$50K a month in potential ROI.', close: 'So is this really about thinking — or deciding if you want the current results or better ones?' },
      { id: 7, category: 'Competition / Alternatives', objection: 'I want to run ads myself.', acknowledge: 'Respect that — taking initiative is key as an agent.', differentiate: 'But ads are just the surface. Real conversion happens after the click — in the automation, follow up, and nurturing. That’s where most agents drop the ball.', anchor: 'You could burn $2,000 on Facebook without a single lead converting. Or invest that into a system that brings in leads and follows up automatically.', close: 'Do you want to test ads blind, or tap into a system that’s already built to convert?' },
      { id: 8, category: 'Competition / Alternatives', objection: 'I’m working with another marketing company.', acknowledge: 'Smart — good agents don’t try to do it all alone.', differentiate: 'But what’s the metric they’re getting you — clicks or clients? We build systems that drive closings, not vanity metrics.', anchor: 'Most agencies charge retainers then outsource. We build an integrated system and tie cost to results.', close: 'Do you want to keep hoping your agency delivers, or invest in a model built to drive ROI you can track?' },
      { id: 9, category: 'Timing', objection: 'Can I just do this later?', acknowledge: 'You absolutely can — timing is everything in this game.', differentiate: 'But every month without a predictable system is another month of hoping for referrals instead of owning your pipeline.', anchor: 'If you close one extra deal this quarter because of this, that’s $10K. How many of those are you willing to delay?', close: 'Do you want to stay reactive — or finally be in control of your lead flow?' },
      { id: 10, category: 'Trust / Proof', objection: 'How do I know this will actually work?', acknowledge: 'That’s a legit question — especially with how much fluff is out there.', differentiate: 'We don’t just build a website. We build a lead acquisition machine — offers, targeting, copy, automation — every piece tested for conversion.', anchor: 'Zillow and Realtor.com sell leads to 5 agents. We give you exclusivity. That’s the difference between shared scraps and pipeline dominance.', close: 'What feels more reliable — renting attention from lead sellers, or owning a system that brings leads directly to you?' },
      { id: 11, category: 'Value / Belief', objection: 'I’ve already spent money on this kind of stuff.', acknowledge: 'Totally get that — a lot of agents come to us after wasting money elsewhere.', differentiate: 'This isn’t one-size-fits-all. It’s a customized lead and conversion system — not just another ad or CRM tool.', anchor: 'What you’ve spent is a sunk cost. If this system gets even one deal, you’re in profit.', close: 'Do you want to keep throwing money at tools, or invest in something designed to get closings?' },
      { id: 12, category: 'Timing', objection: 'How long will it take to see results?', acknowledge: 'Fair question — especially in this market.', differentiate: 'This isn’t slow SEO. It’s direct response — you can see lead flow in weeks.', anchor: 'One deal pays for the whole thing. If you close one in the next 60 days, you’re up 4x.', close: 'Are you looking for slow organic growth, or fast, measurable lead generation?' },
      { id: 13, category: 'Value / Belief', objection: 'I just want leads, not the full system.', acknowledge: 'Makes sense — leads are the lifeblood of your business.', differentiate: 'But leads without follow-up is a bucket with holes. We build the system to close them, not just attract them.', anchor: 'Anyone can get leads. Closing them is where the money is — and that’s what this is built for.', close: 'Do you want more names, or more closings?' },
      { id: 14, category: 'Value / Belief', objection: 'I get leads from referrals.', acknowledge: 'That’s a great sign — people trust you.', differentiate: 'But referrals are passive. You can’t scale or predict them. Our system gives you consistency, not just hope.', anchor: 'Referrals dry up. Marketing doesn’t — when done right. That’s your backup pipeline.', close: 'Do you want to keep waiting on referrals, or build a machine that brings you business daily?' },
      { id: 15, category: 'Price & Money', objection: 'What if I don’t get a return?', acknowledge: 'That’s the only risk that matters.', differentiate: 'We build the system with you. No generic templates — just what works, tested and customized.', anchor: 'Your break-even is one deal. Everything else is upside.', close: 'Do you want to risk staying stuck, or risk one deal’s worth to finally grow?' },
      { id: 16, category: 'Competition / Alternatives', objection: 'I can get leads from Zillow.', acknowledge: 'For sure — a lot of agents do.', differentiate: 'They sell the same lead to 3–5 agents. You’re bidding for attention. We give you exclusive leads and build the system around converting them.', anchor: 'You’re spending ~$2K a month to share leads. This is a fraction of that — and you own it.', close: 'Do you want to rent your leads forever, or own the system that brings them in?' },
      { id: 17, category: 'Timing', objection: 'I’ve got a lot going on right now.', acknowledge: 'Totally get it — listings, buyers, maybe a team to manage.', differentiate: 'This is built because you’re busy. It runs without you. It follows up, books calls, and keeps leads warm — automatically.', anchor: 'How much money slips through the cracks because you’re too busy to follow up? This fixes that.', close: 'Do you want to keep spinning plates, or have a system that handles the follow-up for you?' },
      { id: 18, category: 'Value / Belief', objection: 'I’m not tech-savvy.', acknowledge: 'That’s super common — most agents didn’t get into real estate to mess with software.', differentiate: 'We do everything for you. Setup, automation, even content — no learning curve, no headaches.', anchor: 'You focus on clients. The system works in the background — generating, following up, and nurturing automatically.', close: 'Do you want to keep avoiding tech — or let us handle it so you can focus on closing?' },
      { id: 19, category: 'Value / Belief', objection: 'I’m already doing okay.', acknowledge: 'That’s great — success means you’re doing something right.', differentiate: 'But the agents we work with don’t settle for ‘okay.’ They want to own their market. That takes systems.', anchor: 'Even one more deal a month adds ~$120K a year. That’s what this can do.', close: 'Are you building on momentum — or doubling down while it’s working?' },
      { id: 20, category: 'Decision-Making', objection: 'I’m not sure if I’m ready.', acknowledge: 'That’s real — nobody wants to make a move before they’re ready.', differentiate: 'Readiness isn’t a feeling. It’s a decision. This system helps create momentum, not wait for it.', anchor: 'Every month you delay is a month of missed closings. You could be 30, 60, 90 days ahead by starting now.', close: 'Are you waiting to feel ready — or ready to take control?' },
      { id: 21, category: 'Value / Belief', objection: 'Will this work in my market?', acknowledge: 'Fair question — every market has nuances.', differentiate: 'We don’t do cookie-cutter. Everything is based on your buyer, market, and goals.', anchor: 'Competitive metro or slower rural — same math. If one extra deal is $10K, you’re ahead.', close: 'Do you want to keep guessing, or build something tailored for your area?' },
      { id: 22, category: 'Value / Belief', objection: 'What if this is just another shiny object?', acknowledge: 'Totally get that — most agents have been pitched to death.', differentiate: 'This isn’t a tool. It’s an integrated system for one outcome, more closings. No fluff.', anchor: 'You’re not buying features — you’re buying a system that pays for itself with one deal.', close: 'Do you want another shiny object — or a machine that prints you business?' },
      { id: 23, category: 'Timing', objection: 'I’m in a slower season right now.', acknowledge: 'Makes sense — every market has cycles.', differentiate: 'This is when you want your pipeline full. Momentum now equals closings later.', anchor: 'Slow seasons are when pros double down and take market share from everyone sitting still.', close: 'Are you sitting out — or using this to surge ahead?' },
      { id: 24, category: 'Decision-Making', objection: 'I don’t want to commit to something long-term.', acknowledge: 'Totally fair — commitment without clarity feels risky.', differentiate: 'We start with a short, focused rollout that proves results quickly, then we scale.', anchor: 'Commitment without ROI is risky. ROI first builds a business.', close: 'Are you looking for safe, or something that scales with proof?' },
      { id: 25, category: 'Price & Money', objection: 'I’m not sure if I have the budget.', acknowledge: 'That’s real — cash flow is king in your world.', differentiate: 'This is one of the few investments that does not sit there. It goes to work bringing in revenue.', anchor: 'If you do not invest in lead flow, you are banking on luck. One deal covers the cost. What is the cost of doing nothing?', close: 'Is this about money, or about betting on yourself?' },
      { id: 26, category: 'Value / Belief', objection: 'What if I’m too new to make it work?', acknowledge: 'Starting out is tough, I get that.', differentiate: 'This gives new agents leverage, follow up, and credibility out of the gate.', anchor: 'What takes most agents years to build, we install in weeks.', close: 'Do you want to wait to feel ready, or start with tools that make you ready?' },
      { id: 27, category: 'Value / Belief', objection: 'What if I get too many leads and can’t follow up?', acknowledge: 'Good problem to have, and common once this kicks in.', differentiate: 'We build automated nurture and follow up so you do not lose deals when busy.', anchor: 'Leads do not go cold here. They get messaged, emailed, and texted without you lifting a finger.', close: 'Do you want a safe trickle, or a pipeline that overflows?' },
      { id: 28, category: 'Trust / Proof', objection: 'I’ve been burned before by marketing.', acknowledge: 'Understandable — marketing is full of overpromises.', differentiate: 'We do not sell hype. We install systems and show every part.', anchor: 'One client who converts pays for everything.', close: 'Is this about never trusting again, or finding someone worth trusting?' },
      { id: 29, category: 'Value / Belief', objection: 'This sounds complicated.', acknowledge: 'From the outside it can sound like a lot.', differentiate: 'For you, it is simple. We handle setup, automation, ads, everything. You focus on closing.', anchor: 'Most agents struggle with tech. That is why we do it for you.', close: 'Do you want to stay in the weeds, or operate like a top producer with systems doing the heavy lifting?' },
      { id: 30, category: 'Timing', objection: 'I want to see what happens with the market first.', acknowledge: 'Makes sense — this market is unpredictable.', differentiate: 'Waiting does not protect you, it exposes you. Our system helps you win either way.', anchor: 'You do not need a great market. You need a great pipeline.', close: 'Are you waiting on the market to save you, or taking control of your results?' },
    ];

    const clsx = (...a) => a.filter(Boolean).join(' ');
    const normalizeEntry = e => ({
      id: 0, category: 'Price & Money', objection: '',
      acknowledge: '', differentiate: '', anchor: '', close: '',
      opening: '', discovery: '', transition: '', closingScript: '',
      script: '', notes: '', ...e
    });
    const renumber = arr => arr.map((d, i) => ({ ...d, id: i + 1 }));
    const buildScriptFromADA = e => [
      `Acknowledge, ${e.acknowledge || ''}`,
      `Differentiate, ${e.differentiate || ''}`,
      `Anchor, ${e.anchor || ''}`,
      `Close, ${e.close || ''}`,
    ].join('\n\n');

    const IconSun = props => (<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" {...props}><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path></svg>);
    const IconMoon = props => (<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" {...props}><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"></path></svg>);

    function TextArea({ label, value, onChange, rows = 6, placeholder='' }) {
      return (
        <div className="space-y-1">
          {label ? <label className="text-sm text-gray-600 dark:text-gray-300">{label}</label> : null}
          <textarea rows={rows} value={value ?? ''} onChange={e => onChange(e.target.value)} placeholder={placeholder}
            className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
        </div>
      );
    }
    function CopyButton({ text, className = '' }) {
      const [copied, setCopied] = useState(false);
      return (
        <button onClick={() => { navigator.clipboard.writeText(text || ''); setCopied(true); setTimeout(() => setCopied(false), 1200); }}
          className={clsx('px-3 py-1.5 rounded-xl border dark:border-gray-700', className)}>
          {copied ? 'Copied!' : 'Copy'}
        </button>
      );
    }

    function Gate() {
      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="w-full max-w-xl rounded-2xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-6">
            <div className="flex items-center gap-2 mb-3">
              <img src="https://objectionsiq.com/wp-content/uploads/2025/08/cropped-objectionsiq-favicon.png" alt="ObjectionIQ" className="h-8 w-8 rounded" />
              <div className="text-lg font-bold">Objection<span className="text-emerald-600">IQ</span> Navigator</div>
            </div>
            <h2 className="text-xl font-semibold">Get free access</h2>
            <p className="text-sm text-gray-600 dark:text-gray-300 mt-1">Join with Google, we will save your workspace in the cloud.</p>
            <button onClick={() => window.signIn?.()} className="mt-4 w-full px-4 py-2 rounded-xl border dark:border-gray-700 bg-black text-white">Continue with Google</button>
            <p className="text-xs text-gray-500 dark:text-gray-400 mt-3">Already joined, click the button and choose your account.</p>
          </div>
        </div>
      );
    }

    /* ---------------- NAVIGATOR, with CRUD ---------------- */
    const DEFAULT_FLOW = {
      start:{id:'start',speaker:'You',text:'Most agents I talk to either have a system in place, or they are still figuring out follow up. How are you handling follow up right now',options:[
        {label:'I have a CRM',next:'crm_1'},
        {label:'Leads do not convert',next:'conv_1'},
        {label:'I am too busy',next:'busy_1'}]},
      crm_1:{id:'crm_1',speaker:'You',text:'Does it follow up on its own, or do you do most of it yourself',options:[
        {label:'Mostly me',next:'crm_me'},
        {label:'It is automated',next:'crm_auto'}]},
      crm_me:{id:'crm_me',speaker:'You',text:'When you get busy, do some leads slip through',options:[
        {label:'Yes',next:'bridge_1'},
        {label:'No',next:'crm_probe'}]},
      crm_auto:{id:'crm_auto',speaker:'You',text:'What happens to people who do not reply in the first few days, do you keep outreach going for weeks, or do they go cold',options:[
        {label:'They go cold',next:'bridge_1'},
        {label:'We keep outreach going',next:'bridge_2'}]},
      crm_probe:{id:'crm_probe',speaker:'You',text:'How many touches do they get in the first month',options:[
        {label:'Three to five',next:'bridge_1'},
        {label:'Ten or more',next:'bridge_2'}]},
      conv_1:{id:'conv_1',speaker:'You',text:'Do they never respond, or do they stall after a bit',options:[
        {label:'Never respond',next:'bridge_1'},
        {label:'Stall after a bit',next:'bridge_1'}]},
      busy_1:{id:'busy_1',speaker:'You',text:'When things pile up, what gets pushed first, new leads, or past clients',options:[
        {label:'New leads',next:'bridge_1'},
        {label:'Past clients',next:'bridge_1'}]},
      bridge_1:{id:'bridge_1',speaker:'You',text:'Sounds like there is a gap. If I show a simple way to keep follow up running on its own, keep people warm for months, and ping you when they are ready, would you want a look',options:[
        {label:'Yes',next:'close_book'},
        {label:'Maybe later',next:'close_soft'},
        {label:'No',next:'close_no'}]},
      bridge_2:{id:'bridge_2',speaker:'You',text:'You are ahead of most. If we add speed to lead and long term nurture so you work only hot replies, would a five minute walk through help you decide',options:[
        {label:'Yes',next:'close_book'},
        {label:'Send info',next:'close_email'},
        {label:'Not now',next:'close_soft'}]},
      close_book:{id:'close_book',speaker:'You',text:'Great. What works better, a short Zoom this afternoon, or tomorrow morning',options:[]},
      close_email:{id:'close_email',speaker:'You',text:'Easy. I will send a short video and a sample follow up map. What is the best email',options:[]},
      close_soft:{id:'close_soft',speaker:'You',text:'All good. I will send a two minute overview so you can decide if a demo is worth it',options:[]},
      close_no:{id:'close_no',speaker:'You',text:'No problem. If you want a simple way to keep follow up moving without extra effort, reach out',options:[]}
    };

    function Navigator() {
      const [flow, setFlow] = useState(() => {
        try { return JSON.parse(localStorage.getItem(L_FLOW) || 'null') || DEFAULT_FLOW; } catch { return DEFAULT_FLOW; }
      });
      const [startId, setStartId] = useState(() => localStorage.getItem(L_START) || 'start');
      const [history, setHistory] = useState([startId]);
      const [transcript, setTranscript] = useState([]);
      const [admin, setAdmin] = useState(false);
      const [editId, setEditId] = useState(startId);
      const [nodeDraft, setNodeDraft] = useState(flow[startId]);
      const [optionDrafts, setOptionDrafts] = useState(flow[startId]?.options || []);

      useEffect(() => { localStorage.setItem(L_FLOW, JSON.stringify(flow)); }, [flow]);
      useEffect(() => { localStorage.setItem(L_START, startId); }, [startId]);

      const current = flow[history[history.length - 1]];
      useEffect(() => {
        if (!current) return;
        setTranscript(t => [...t, { speaker: current.speaker, text: current.text }]);
      }, [history[history.length - 1]]); // new node, append speaker line

      function go(nextId, label) {
        if (!nextId) return;
        setTranscript(t => [...t, { speaker: 'Realtor', text: label }]);
        setHistory(h => [...h, nextId]);
      }
      function back() {
        if (history.length <= 1) return;
        setHistory(h => h.slice(0, -1));
        setTranscript(t => t.slice(0, -1)); // drop last Realtor line
      }
      function resetFlow() {
        setHistory([startId]);
        setTranscript([]);
      }

      function openEditor(id) {
        const n = flow[id];
        setEditId(id);
        setNodeDraft({ id: n?.id || id, speaker: n?.speaker || 'You', text: n?.text || '' });
        setOptionDrafts(n?.options || []);
        setAdmin(true);
      }
      useEffect(() => { openEditor(history[history.length - 1]); }, []); // init

      function saveNode() {
        if (!nodeDraft?.id) { alert('Node id is required'); return; }
        const obj = {
          id: nodeDraft.id,
          speaker: nodeDraft.speaker || 'You',
          text: nodeDraft.text || '',
          options: optionDrafts.filter(o => (o.label || '').trim().length),
        };
        setFlow(prev => ({ ...prev, [obj.id]: obj }));
        setEditId(obj.id);
        alert('Node saved');
      }
      function addNode() {
        const id = prompt('New node id');
        if (!id) return;
        if (flow[id]) { alert('Id exists'); return; }
        const obj = { id, speaker: 'You', text: '', options: [] };
        setFlow(prev => ({ ...prev, [id]: obj }));
        setEditId(id);
        setNodeDraft(obj);
        setOptionDrafts([]);
      }
      function deleteNode() {
        const id = editId;
        if (!id || !flow[id]) return;
        if (!confirm('Delete node, ' + id + '')) return;
        const copy = { ...flow };
        delete copy[id];
        setFlow(copy);
        const fallback = startId in copy ? startId : Object.keys(copy)[0] || 'start';
        setEditId(fallback);
        setNodeDraft(copy[fallback] || { id: 'start', speaker: 'You', text: '', options: [] });
        setOptionDrafts(copy[fallback]?.options || []);
        if (history[history.length - 1] === id) resetFlow();
      }
      function setAsStart() {
        if (!nodeDraft?.id) return;
        setStartId(nodeDraft.id);
        setHistory([nodeDraft.id]);
        setTranscript([]);
      }
      function addOptionRow() {
        setOptionDrafts(o => [...o, { label: '', next: '' }]);
      }
      function updateOptionRow(i, key, val) {
        setOptionDrafts(o => o.map((x, idx) => idx === i ? { ...x, [key]: val } : x));
      }
      function removeOptionRow(i) {
        setOptionDrafts(o => o.filter((_, idx) => idx !== i));
      }
      function exportFlow() {
        const blob = new Blob([JSON.stringify({ flow, start: startId }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'navigator-flow.json'; a.click(); URL.revokeObjectURL(url);
      }
      function importFlow(e) {
        const f = e.target.files?.[0]; if (!f) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const obj = JSON.parse(r.result);
            const nf = obj?.flow && typeof obj.flow === 'object' ? obj.flow : null;
            const ns = obj?.start || 'start';
            if (!nf) throw new Error('Invalid file');
            setFlow(nf);
            setStartId(ns);
            setHistory([ns]);
            setTranscript([]);
            openEditor(ns);
            alert('Flow imported');
          } catch (err) { alert('Import failed, ' + err.message); }
        };
        r.readAsText(f);
        e.target.value = '';
      }

      return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div className="lg:col-span-1 space-y-3">
            <div className="rounded-2xl border dark:border-gray-700 p-4 bg-white dark:bg-gray-800">
              <div className="flex items-center justify-between gap-2">
                <div className="text-sm font-semibold">Navigator</div>
                <div className="flex gap-2">
                  <button onClick={back} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Back</button>
                  <button onClick={resetFlow} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Reset</button>
                  <button onClick={() => setAdmin(a => !a)} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">{admin ? 'Hide Admin' : 'Admin'}</button>
                </div>
              </div>
              <div className="mt-3 rounded-xl border dark:border-gray-700 p-3 bg-gray-50 dark:bg-gray-900">
                <div className="text-sm text-gray-500 dark:text-gray-300 mb-1">Question</div>
                <div className="whitespace-pre-line">{current?.text || 'Missing node'}</div>
              </div>
              <div className="mt-2 flex flex-wrap gap-2">
                {(current?.options || []).map((o, i) => (
                  <button key={i} onClick={() => go(o.next, o.label)} className="px-3 py-1.5 rounded-xl border dark:border-gray-700 bg-white dark:bg-gray-900">
                    {o.label}
                  </button>
                ))}
              </div>

              <div className="mt-3">
                <div className="text-sm text-gray-500 dark:text-gray-300 mb-1">Transcript</div>
                <pre className="rounded-xl border dark:border-gray-700 p-3 bg-gray-50 dark:bg-gray-900 whitespace-pre-wrap text-sm">
{transcript.map(t => `${t.speaker} | ${t.text}`).join('\n')}
                </pre>
              </div>
            </div>

            {admin && (
              <div className="rounded-2xl border dark:border-gray-700 p-4 bg-white dark:bg-gray-800">
                <div className="flex items-center justify-between">
                  <div className="text-sm font-semibold">Editor, current node</div>
                  <div className="flex gap-2">
                    <button onClick={addNode} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Add</button>
                    <button onClick={setAsStart} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Set Start</button>
                    <button onClick={deleteNode} className="px-3 py-1.5 rounded-xl border dark:border-gray-700 text-rose-600">Delete</button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                  <div>
                    <label className="text-sm text-gray-600 dark:text-gray-300">Node ID</label>
                    <input value={nodeDraft?.id || ''} onChange={e => setNodeDraft(v => ({ ...v, id: e.target.value }))} className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
                  </div>
                  <div>
                    <label className="text-sm text-gray-600 dark:text-gray-300">Speaker</label>
                    <input value={nodeDraft?.speaker || 'You'} onChange={e => setNodeDraft(v => ({ ...v, speaker: e.target.value }))} className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
                  </div>
                </div>

                <div className="mt-3">
                  <TextArea label="Text" value={nodeDraft?.text} onChange={val => setNodeDraft(v => ({ ...v, text: val }))} rows={4} />
                </div>

                <div className="mt-3">
                  <div className="flex items-center justify-between">
                    <div className="text-sm text-gray-600 dark:text-gray-300">Options</div>
                    <button onClick={addOptionRow} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Add option</button>
                  </div>
                  <div className="space-y-2 mt-2">
                    {optionDrafts.map((op, i) => (
                      <div key={i} className="grid grid-cols-1 md:grid-cols-5 gap-2">
                        <input value={op.label} onChange={e => updateOptionRow(i, 'label', e.target.value)} placeholder="label" className="md:col-span-2 rounded-xl border px-3 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
                        <input value={op.next} onChange={e => updateOptionRow(i, 'next', e.target.value)} placeholder="next id" className="md:col-span-2 rounded-xl border px-3 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
                        <button onClick={() => removeOptionRow(i)} className="px-3 py-1.5 rounded-xl border dark:border-gray-700 text-rose-600">Remove</button>
                      </div>
                    ))}
                    {!optionDrafts.length && <div className="text-xs text-gray-500">No options yet</div>}
                  </div>
                </div>

                <div className="flex items-center gap-2 mt-3">
                  <button onClick={saveNode} className="px-3 py-1.5 rounded-xl border bg-black text-white">Save node</button>
                  <button onClick={() => openEditor(nodeDraft?.id || startId)} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Reload</button>
                  <button onClick={exportFlow} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Export</button>
                  <label className="px-3 py-1.5 rounded-xl border dark:border-gray-700 cursor-pointer">
                    Import
                    <input type="file" accept="application/json" className="hidden" onChange={importFlow} />
                  </label>
                </div>
              </div>
            )}

            <div className="rounded-2xl border dark:border-gray-700 p-4 bg-white dark:bg-gray-800">
              <div className="text-sm text-gray-600 dark:text-gray-300">Jump to node</div>
              <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-64 overflow-auto">
                {Object.values(flow).map(n => (
                  <button key={n.id} onClick={() => { setHistory([n.id]); setTranscript([]); openEditor(n.id); }}
                    className="px-2 py-1.5 rounded-xl border dark:border-gray-700 text-sm bg-white dark:bg-gray-900">
                    {n.id}
                  </button>
                ))}
              </div>
            </div>
          </div>

          <div className="lg:col-span-2">
            <div className="rounded-2xl border dark:border-gray-700 p-4 bg-white dark:bg-gray-800">
              <div className="text-sm text-gray-600 dark:text-gray-300">Current node JSON</div>
              <pre className="mt-2 rounded-xl border dark:border-gray-700 p-3 bg-gray-50 dark:bg-gray-900 whitespace-pre-wrap text-xs">
{JSON.stringify(current || {}, null, 2)}
              </pre>
            </div>
          </div>
        </div>
      );
    }

    /* ---------------- LIBRARY, your existing app ---------------- */
    function CategoryManager({ open, onClose, categories, setCategories, data, setData }) {
      const [local, setLocal] = useState(categories);
      const [newCat, setNewCat] = useState('');
      useEffect(() => { if (open) setLocal(categories); }, [open, categories]);

      function addCat() {
        const name = newCat.trim();
        if (!name) return;
        if (local.includes(name)) return alert('Category exists');
        setLocal(prev => [...prev, name]);
        setNewCat('');
      }
      function renameCat(oldName, nextName) {
        nextName = (nextName || '').trim();
        if (!nextName) return;
        if (nextName !== oldName && local.includes(nextName)) return alert('Category exists');
        setLocal(list => list.map(c => c === oldName ? nextName : c));
        setData(prev => prev.map(d => d.category === oldName ? { ...d, category: nextName } : d));
      }
      function deleteCat(name) {
        if (!confirm(`Delete "${name}"`)) return;
        const fallback = 'Uncategorized';
        const nextList = local.filter(c => c !== name);
        if (!nextList.includes(fallback)) nextList.push(fallback);
        setLocal(nextList);
        setData(prev => prev.map(d => d.category === name ? { ...d, category: fallback } : d));
      }
      function save() { setCategories(local); onClose(); }
      if (!open) return null;

      return (
        <div className="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
          <div className="bg-white dark:bg-gray-800 dark:text-gray-100 rounded-2xl w-full max-w-xl p-5 border dark:border-gray-700">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-xl font-bold">Manage Categories</h2>
              <button onClick={onClose} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Close</button>
            </div>
            <div className="space-y-3 max-h-[60vh] overflow-auto">
              {local.map((c, i) => (
                <div key={c + '_' + i} className="flex items-center gap-2">
                  <input defaultValue={c} onBlur={e => renameCat(c, e.target.value)}
                    className="flex-1 rounded-xl border px-3 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
                  <button onClick={() => deleteCat(c)} className="px-3 py-1.5 rounded-xl border dark:border-gray-700 text-rose-600">Delete</button>
                </div>
              ))}
            </div>
            <div className="flex items-center gap-2 mt-4">
              <input value={newCat} onChange={e => setNewCat(e.target.value)} placeholder="New category"
                className="flex-1 rounded-xl border px-3 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
              <button onClick={addCat} className="px-3 py-1.5 rounded-xl border bg-black text-white">Add</button>
            </div>
            <div className="flex justify-end mt-4">
              <button onClick={save} className="px-3 py-1.5 rounded-xl border bg-black text-white">Save</button>
            </div>
          </div>
        </div>
      );
    }

    function EditorCard({ mode, draft, setDraft, onCancel, onSave, categories }) {
      function regenScript() { setDraft(v => ({ ...v, script: buildScriptFromADA(v) })); }
      return (
        <div className="bg-white dark:bg-gray-800 dark:border-gray-700 rounded-3xl border p-5 md:p-8 shadow-sm">
          <div className="flex items-center justify-between">
            <h2 className="text-2xl font-bold">{mode === 'add' ? 'Add New Objection' : 'Edit Objection'}</h2>
            <div className="flex gap-2">
              <button onClick={onCancel} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Cancel</button>
              <button onClick={onSave} className="px-3 py-1.5 rounded-xl border bg-black text-white">Save</button>
            </div>
          </div>
          <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-1">
              <label className="text-sm text-gray-600 dark:text-gray-300">ID</label>
              <input value={draft?.id ?? ''} onChange={e => setDraft(v => ({ ...v, id: Number(e.target.value)||0 }))}
                className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
            </div>
            <div className="space-y-1">
              <label className="text-sm text-gray-600 dark:text-gray-300">Category</label>
              <select value={draft?.category ?? (categories[0] || 'Uncategorized')}
                onChange={e => setDraft(v => ({ ...v, category: e.target.value }))}
                className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700">
                {categories.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </div>
          </div>
          <div className="mt-4 space-y-1">
            <label className="text-sm text-gray-600 dark:text-gray-300">Objection</label>
            <input value={draft?.objection ?? ''} onChange={e => setDraft(v => ({ ...v, objection: e.target.value }))}
              className="w-full rounded-xl border px-3 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 dark:border-gray-700" />
          </div>
          <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <TextArea label="Acknowledge" value={draft?.acknowledge} onChange={val => setDraft(v => ({ ...v, acknowledge: val }))} />
            <TextArea label="Differentiate" value={draft?.differentiate} onChange={val => setDraft(v => ({ ...v, differentiate: val }))} />
            <TextArea label="Anchor" value={draft?.anchor} onChange={val => setDraft(v => ({ ...v, anchor: val }))} />
            <TextArea label="Close" value={draft?.close} onChange={val => setDraft(v => ({ ...v, close: val }))} />
          </div>
          <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <TextArea label="Opening Script" value={draft?.opening} onChange={val => setDraft(v => ({ ...v, opening: val }))} rows={8} />
            <TextArea label="Discovery Questions" value={draft?.discovery} onChange={val => setDraft(v => ({ ...v, discovery: val }))} rows={8} />
            <TextArea label="Transition Bridge" value={draft?.transition} onChange={val => setDraft(v => ({ ...v, transition: val }))} rows={6} />
            <TextArea label="Closing Script" value={draft?.closingScript} onChange={val => setDraft(v => ({ ...v, closingScript: val }))} rows={6} />
          </div>
          <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <div className="flex items-center justify-between">
                <label className="text-sm text-gray-600 dark:text-gray-300">Composed Script</label>
                <div className="flex gap-2">
                  <button onClick={regenScript} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Generate from ADA+C</button>
                  <CopyButton text={draft?.script} />
                </div>
              </div>
              <TextArea value={draft?.script} onChange={val => setDraft(v => ({ ...v, script: val }))} rows={10} placeholder="Auto generated or paste your talk track here" />
            </div>
            <div className="space-y-2">
              <div className="flex items-center justify-between">
                <label className="text-sm text-gray-600 dark:text-gray-300">Internal Notes</label>
                <CopyButton text={draft?.notes} />
              </div>
              <TextArea value={draft?.notes} onChange={val => setDraft(v => ({ ...v, notes: val }))} rows={10} placeholder="Coaching cues, market notes, comps" />
            </div>
          </div>
        </div>
      );
    }

    function LibraryView({ uid }) {
      const [isDark, setIsDark] = useState(() => document.documentElement.classList.contains('dark'));
      function toggleTheme() {
        const next = !isDark;
        setIsDark(next);
        document.documentElement.classList.toggle('dark', next);
        localStorage.setItem('theme', next ? 'dark' : 'light');
      }

      const [data, setData] = useState(() => {
        try {
          const v4 = localStorage.getItem(LS_DATA);
          if (v4) return JSON.parse(v4).map(normalizeEntry);
        } catch {}
        return DEFAULT_DATA.map(normalizeEntry);
      });
      const [categories, setCategories] = useState(() => {
        try {
          const saved = JSON.parse(localStorage.getItem(LS_CATS) || 'null');
          if (Array.isArray(saved) && saved.length) return Array.from(new Set([...saved, 'Uncategorized']));
        } catch {}
        const fromData = Array.from(new Set(data.map(d => d.category)));
        return Array.from(new Set([...DEFAULT_CATS, ...fromData, 'Uncategorized']));
      });

      const [saving, setSaving] = useState(false);
      const [progress, setProgress] = useState(0);
      const [showUpdated, setShowUpdated] = useState(false);

      const [authReady, setAuthReady] = useState(true);
      const [isSharedView, setIsSharedView] = useState(false);

      useEffect(() => { localStorage.setItem(LS_DATA, JSON.stringify(data)); }, [data]);
      useEffect(() => { localStorage.setItem(LS_CATS, JSON.stringify(categories)); }, [categories]);

      const [q, setQ] = useState('');
      const [categoryFilter, setCategoryFilter] = useState('All');
      const [activeIdx, setActiveIdx] = useState(0);
      const [mode, setMode] = useState('view');
      const [draft, setDraft] = useState(null);
      const [tab, setTab] = useState('ada');
      const [quickEdit, setQuickEdit] = useState(false);
      const [quickDraft, setQuickDraft] = useState(null);
      const [catMgrOpen, setCatMgrOpen] = useState(false);
      const [openActionId, setOpenActionId] = useState(null);

      const searchRef = useRef(null);
      const fileRef = useRef(null);
      const detailRef = useRef(null);
      const userSelectedRef = useRef(false);

      useEffect(() => {
        if (!uid) return;
        let intervalId = null;
        const t = setTimeout(() => {
          setSaving(true);
          setProgress(10);
          intervalId = setInterval(() => { setProgress(p => Math.min(p + Math.random() * 20, 90)); }, 300);
          window.saveToCloud(uid, data, categories)
            .then(() => { setProgress(100); setShowUpdated(true); setTimeout(() => setShowUpdated(false), 1600); })
            .catch(err => console.error('Cloud save failed', err))
            .finally(() => { if (intervalId) clearInterval(intervalId); setTimeout(() => { setSaving(false); setProgress(0); }, 300); });
        }, 400);
        return () => { clearTimeout(t); if (intervalId) clearInterval(intervalId); };
      }, [uid, data, categories]);

      useEffect(() => { setQuickDraft(normalizeEntry(filtered[activeIdx] || {})); }, [activeIdx]);

      const filtered = useMemo(() => {
        const words = q.toLowerCase().split(/\s+/).filter(Boolean);
        return data.filter(d => {
          const inCat = categoryFilter === 'All' || d.category === categoryFilter;
          const hay = `${d.objection} ${d.acknowledge} ${d.differentiate} ${d.anchor} ${d.close} ${d.script||''} ${d.notes||''} ${d.opening||''} ${d.discovery||''} ${d.transition||''} ${d.closingScript||''}`.toLowerCase();
          return inCat && words.every(w => hay.includes(w));
        });
      }, [q, categoryFilter, data]);

      const active = filtered[activeIdx] || filtered[0];

      useEffect(() => {
        function onKey(e) {
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); searchRef.current?.focus(); }
          const tag = e.target.tagName;
          if (tag === 'INPUT' || tag === 'TEXTAREA') return;
          if (e.key === 'ArrowDown') setActiveIdx(i => Math.min(i + 1, Math.max(0, filtered.length - 1)));
          if (e.key === 'ArrowUp') setActiveIdx(i => Math.max(i - 1, 0));
          if (e.key === 'Escape') setOpenActionId(null);
        }
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [filtered.length]);

      useEffect(() => { setActiveIdx(0); }, [q, categoryFilter]);

      function beginAdd() {
        setMode('add');
        const nextId = (data.length ? Math.max(...data.map(d => d.id)) : 0) + 1;
        setDraft(normalizeEntry({ id: nextId, category: categories[0] || 'Uncategorized', objection: '' }));
      }
      function beginEdit(item) { setMode('edit'); setDraft(normalizeEntry(item)); }
      function cancelEdit() { setMode('view'); setDraft(null); }
      function saveDraft() {
        if (!draft.objection?.trim()) return alert('Objection is required');
        if (!draft.category) return alert('Category is required');
        if (!categories.includes(draft.category)) setCategories(prev => Array.from(new Set([...prev, draft.category])));
        if (mode === 'add') setData(prev => [...prev, { ...draft }]);
        if (mode === 'edit') setData(prev => prev.map(d => d.id === draft.id ? { ...draft } : d));
        setMode('view'); setDraft(null);
      }
      function deleteItem(id) {
        if (!confirm('Delete this objection')) return;
        setData(prev => renumber(prev.filter(d => d.id !== id)));
        setOpenActionId(null);
        setActiveIdx(0);
      }
      function duplicateItem(item) {
        const nextId = (data.length ? Math.max(...data.map(d => d.id)) : 0) + 1;
        const clone = normalizeEntry({ ...item, id: nextId, objection: item.objection + ' (copy)' });
        setData(prev => [...prev, clone]);
        setOpenActionId(null);
      }
      function exportJSON() {
        const blob = new Blob([JSON.stringify({ data, categories }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'objection_navigator.json'; a.click(); URL.revokeObjectURL(url);
      }
      function importJSON(e) {
        const file = e.target.files?.[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(reader.result);
            const arr = Array.isArray(obj?.data) ? obj.data : (Array.isArray(obj) ? obj : null);
            if (!arr) throw new Error('Invalid file');
            const cats = Array.isArray(obj?.categories) ? obj.categories : categories;
            setCategories(prev => Array.from(new Set([...(cats||[]), 'Uncategorized'])));
            setData(arr.map(normalizeEntry));
            setActiveIdx(0);
          } catch (err) { alert('Import failed, ' + err.message); }
        };
        reader.readAsText(file);
        e.target.value = '';
      }

      function qeField(k, v) { setQuickDraft(prev => ({ ...prev, [k]: v })); }
      function qeSave() { if (!quickDraft) return; setData(prev => prev.map(d => d.id === quickDraft.id ? { ...normalizeEntry(quickDraft) } : d)); setQuickEdit(false); }
      function qeCancel() { setQuickDraft(normalizeEntry(active)); setQuickEdit(false); }

      const badgeClass = cat => CATEGORY_BADGES[cat] || 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-700';

      return (
        <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="md:col-span-1 space-y-3">
            <header className="flex items-center justify-between">
              <h1 className="text-xl md:text-2xl font-bold leading-tight">
                <span className="inline-flex items-center gap-2">
                  <img src="https://objectionsiq.com/wp-content/uploads/2025/08/cropped-objectionsiq-favicon.png" alt="ObjectionIQ logo" className="h-7 w-7 md:h-8 md:w-8 shrink-0 rounded" />
                  <span>Objection<span className="text-emerald-600">IQ</span> Navigator</span>
                </span>
                <span className="block text-xs md:text-sm text-gray-500 mt-1">By Digital Footprint</span>
              </h1>
              <div className="flex items-center gap-3">
                <button onClick={() => {
                  const next = !document.documentElement.classList.contains('dark');
                  document.documentElement.classList.toggle('dark', next);
                  localStorage.setItem('theme', next ? 'dark' : 'light');
                }} className="px-2 py-1.5 rounded-xl border dark:border-gray-700" title="Toggle theme">
                  {document.documentElement.classList.contains('dark') ? <IconSun /> : <IconMoon />}
                </button>
                <button id="btn-sign-in" onClick={() => window.signIn?.()} className="px-3 py-1.5 rounded-xl border dark:border-gray-700 hidden">Sign in</button>
                <button id="btn-sign-out" onClick={() => window.signOutSafe?.()} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Sign out</button>
                <span id="user-name" className="text-sm text-gray-600 dark:text-gray-300"></span>
              </div>
            </header>

            <div className="flex flex-wrap gap-2">
              <button onClick={() => setMode('add')} className="px-3 py-1.5 rounded-xl border bg-black text-white">Add New</button>
              <button onClick={() => setCatMgrOpen(true)} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Categories</button>
              <button onClick={exportJSON} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Export</button>
              <button onClick={() => document.getElementById('import-file').click()} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Import</button>
              <input id="import-file" type="file" accept="application/json" className="hidden" onChange={importJSON} />
            </div>

            <div className="flex items-center gap-2">
              <input ref={searchRef} value={q} onChange={e => setQ(e.target.value)}
                placeholder="Search objections, ADA+C, scripts, notes"
                className="w-full rounded-2xl border border-gray-300 dark:border-gray-700 px-4 py-2 bg-white dark:bg-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:focus:ring-gray-600" />
            </div>

            <div className="flex flex-wrap gap-2">
              {['All', ...categories].map(cat => (
                <button key={cat} onClick={() => setCategoryFilter(cat)}
                  className={clsx('px-3 py-1 rounded-full border text-sm dark:border-gray-700', cat !== 'All' && badgeClass(cat), categoryFilter === cat && 'ring-2 ring-black/10 dark:ring-white/10')}>
                  {cat}
                </button>
              ))}
            </div>

            <div className="bg-gray-50 dark:bg-gray-900 rounded-2xl border dark:border-gray-700 overflow-hidden">
              <div className="max-h-[60vh] overflow-auto divide-y dark:divide-gray-800">
                {filtered.map((item, idx) => {
                  const isActive = idx === activeIdx;
                  return (
                    <div key={item.id}
                      className={clsx('p-3 space-y-2 border-b dark:border-gray-800', isActive ? 'bg-emerald-100 dark:bg-emerald-900/40' : 'hover:bg-gray-50 dark:hover:bg-gray-800')}
                      onClick={() => { setActiveIdx(idx); setMode('view'); }}>
                      <div className="flex items-start justify-between gap-2">
                        <div className="text-left flex-1">
                          <div className="font-medium">{item.id}. {item.objection}</div>
                        </div>
                        <div className={clsx('px-2 py-0.5 rounded-full border text-xs', badgeClass(item.category))}>{item.category}</div>
                        <div className="flex gap-2">
                          <button onClick={(e) => { e.stopPropagation(); setMode('edit'); setDraft(item); }}
                            className="px-2 py-1 text-xs rounded border dark:border-gray-700">Edit</button>
                          <button onClick={(e) => { e.stopPropagation(); const nextId = (data.length ? Math.max(...data.map(d => d.id)) : 0) + 1; const clone = normalizeEntry({ ...item, id: nextId, objection: item.objection + ' (copy)' }); setData(prev => [...prev, clone]); }}
                            className="px-2 py-1 text-xs rounded border dark:border-gray-700">Duplicate</button>
                          <button onClick={(e) => { e.stopPropagation(); deleteItem(item.id); }}
                            className="px-2 py-1 text-xs rounded border dark:border-gray-700 text-rose-700">Delete</button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          <div className="md:col-span-2">
            {mode === 'view' && active ? (
              <div id={`resp-${active.id}`} className="bg-white dark:bg-gray-800 dark:border-gray-700 rounded-3xl border p-5 md:p-8 shadow-sm">
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <div className={clsx('inline-flex items-center gap-2 px-2.5 py-1 rounded-full border text-xs', CATEGORY_BADGES[active.category] || '')}>{active.category}</div>
                    <h2 className="text-2xl font-bold mt-3">{active.id}. {active.objection}</h2>
                  </div>
                  <div className="flex gap-2 items-center">
                    <button onClick={() => setQuickEdit(q => !q)} className={clsx('px-3 py-1.5 rounded-xl border dark:border-gray-700', quickEdit && 'bg-black text-white')}>{quickEdit ? 'Done' : 'Quick Edit'}</button>
                    <button onClick={() => setMode('edit')} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Full Edit</button>
                  </div>
                </div>

                <div className="mt-4 flex gap-2">
                  <button className={clsx('px-3 py-1.5 rounded-xl border dark:border-gray-700', tab==='ada' && 'bg-black text-white')} onClick={() => setTab('ada')}>ADA+C</button>
                  <button className={clsx('px-3 py-1.5 rounded-xl border dark:border-gray-700', tab==='scripts' && 'bg-black text-white')} onClick={() => setTab('scripts')}>Scripts and Notes</button>
                </div>

                {tab === 'ada' ? (
                  <div className="mt-6 space-y-6 prose">
                    <section>
                      <h3 className="font-semibold mb-2">Acknowledge</h3>
                      {quickEdit ? <TextArea value={quickDraft?.acknowledge} onChange={val => setQuickDraft(v => ({ ...v, acknowledge: val }))} /> : <p className="leading-relaxed whitespace-pre-line">{active.acknowledge}</p>}
                    </section>
                    <section>
                      <h3 className="font-semibold mb-2">Differentiate</h3>
                      {quickEdit ? <TextArea value={quickDraft?.differentiate} onChange={val => setQuickDraft(v => ({ ...v, differentiate: val }))} /> : <p className="leading-relaxed whitespace-pre-line">{active.differentiate}</p>}
                    </section>
                    <section>
                      <h3 className="font-semibold mb-2">Anchor</h3>
                      {quickEdit ? <TextArea value={quickDraft?.anchor} onChange={val => setQuickDraft(v => ({ ...v, anchor: val }))} /> : <p className="leading-relaxed whitespace-pre-line">{active.anchor}</p>}
                    </section>
                    <section>
                      <h3 className="font-semibold mb-2">Close</h3>
                      {quickEdit ? <TextArea value={quickDraft?.close} onChange={val => setQuickDraft(v => ({ ...v, close: val }))} /> : <p className="italic leading-relaxed">{active.close}</p>}
                    </section>
                    <section className="pt-2">
                      <div className="flex items-center justify-between">
                        <h3 className="font-semibold mb-2">Composed Script</h3>
                        <CopyButton text={quickEdit ? (quickDraft?.script || buildScriptFromADA(quickDraft || {})) : (active.script || buildScriptFromADA(active))} />
                      </div>
                      {quickEdit ? <TextArea value={quickDraft?.script} onChange={val => setQuickDraft(v => ({ ...v, script: val }))} rows={10} /> : <pre className="bg-gray-50 dark:bg-gray-900 rounded-xl p-4">{active.script || buildScriptFromADA(active)}</pre>}
                    </section>
                    {quickEdit && (
                      <div className="flex gap-2 pt-2">
                        <button onClick={() => { setData(prev => prev.map(d => d.id === quickDraft.id ? { ...normalizeEntry(quickDraft) } : d)); setQuickEdit(false); }} className="px-3 py-1.5 rounded-xl border bg-black text-white">Save Changes</button>
                        <button onClick={() => { setQuickDraft(normalizeEntry(active)); setQuickEdit(false); }} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Cancel</button>
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="mt-6 space-y-6 prose">
                    <section>
                      <h3 className="font-semibold mb-2">Opening Script</h3>
                      {quickEdit ? <TextArea value={quickDraft?.opening} onChange={val => setQuickDraft(v => ({ ...v, opening: val }))} rows={8} /> : <pre className="bg-gray-50 dark:bg-gray-900 rounded-xl p-4">{active.opening || '—'}</pre>}
                    </section>
                    <section>
                      <h3 className="font-semibold mb-2">Discovery Questions</h3>
                      {quickEdit ? <TextArea value={quickDraft?.discovery} onChange={val => setQuickDraft(v => ({ ...v, discovery: val }))} rows={8} /> : <pre className="bg-gray-50 dark:bg-gray-900 rounded-xl p-4">{active.discovery || '—'}</pre>}
                    </section>
                    <section>
                      <h3 className="font-semibold mb-2">Transition Bridge</h3>
                      {quickEdit ? <TextArea value={quickDraft?.transition} onChange={val => setQuickDraft(v => ({ ...v, transition: val }))} rows={6} /> : <pre className="bg-gray-50 dark:bg-gray-900 rounded-xl p-4">{active.transition || '—'}</pre>}
                    </section>
                    <section>
                      <h3 className="font-semibold mb-2">Closing Script</h3>
                      {quickEdit ? <TextArea value={quickDraft?.closingScript} onChange={val => setQuickDraft(v => ({ ...v, closingScript: val }))} rows={6} /> : <pre className="bg-gray-50 dark:bg-gray-900 rounded-xl p-4">{active.closingScript || '—'}</pre>}
                    </section>
                    <section>
                      <div className="flex items-center justify-between">
                        <h3 className="font-semibold mb-2">Internal Notes</h3>
                        <CopyButton text={quickEdit ? (quickDraft?.notes||'') : (active.notes || '')} />
                      </div>
                      {quickEdit ? <TextArea value={quickDraft?.notes} onChange={val => setQuickDraft(v => ({ ...v, notes: val }))} rows={8} /> : <pre className="bg-gray-50 dark:bg-gray-900 rounded-xl p-4">{active.notes || '—'}</pre>}
                    </section>
                    {quickEdit && (
                      <div className="flex gap-2 pt-2">
                        <button onClick={() => { setData(prev => prev.map(d => d.id === quickDraft.id ? { ...normalizeEntry(quickDraft) } : d)); setQuickEdit(false); }} className="px-3 py-1.5 rounded-xl border bg-black text-white">Save Changes</button>
                        <button onClick={() => { setQuickDraft(normalizeEntry(active)); setQuickEdit(false); }} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Cancel</button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            ) : (
              <EditorCard mode={mode} draft={draft} setDraft={setDraft} onCancel={() => { setMode('view'); setDraft(null); }} onSave={() => {
                if (!draft.objection?.trim()) return alert('Objection is required');
                if (!draft.category) return alert('Category is required');
                if (!categories.includes(draft.category)) setCategories(prev => Array.from(new Set([...prev, draft.category])));
                if (mode === 'add') setData(prev => [...prev, { ...draft }]);
                if (mode === 'edit') setData(prev => prev.map(d => d.id === draft.id ? { ...draft } : d));
                setMode('view'); setDraft(null);
              }} categories={categories} />
            )}
          </div>

          {/* Progress and updated */}
          <div className="fixed top-0 left-0 right-0 h-1 z-50">
            <div className={clsx("h-1 bg-emerald-500 transition-all", saving ? "opacity-100" : "opacity-0")}
              style={{ width: saving ? `${progress}%` : '0%' }} />
          </div>
          {showUpdated && (
            <div className="fixed top-3 right-3 z-50 px-3 py-1.5 rounded-lg text-sm bg-emerald-600 text-white shadow">
              Updated 👍
            </div>
          )}

          <CategoryManager open={catMgrOpen} onClose={() => setCatMgrOpen(false)}
            categories={categories} setCategories={setCategories} data={data} setData={setData} />
        </div>
      );
    }

    /* ---------------- Shell with tabs ---------------- */
    function App() {
      const [uid, setUid] = useState(window.getUID?.() || null);
      const [authReady, setAuthReady] = useState(false);
      const [tab, setTab] = useState('library'); // 'library' or 'navigator'

      useEffect(() => {
        function onAuthChanged(e) { setUid(e.detail.uid || null); setAuthReady(true); }
        window.addEventListener('auth-changed', onAuthChanged);
        return () => window.removeEventListener('auth-changed', onAuthChanged);
      }, []);

      if (!authReady) return <div className="min-h-screen flex items-center justify-center p-10 text-sm text-gray-500">Checking your session...</div>;
      if (!uid) return <Gate />;

      return (
        <div className="min-h-screen w-full p-4 md:p-8">
          <div className="max-w-7xl mx-auto mb-4 flex items-center justify-between">
            <div className="text-xl font-bold">Objection<span className="text-emerald-600">IQ</span> Workspace</div>
            <div className="flex gap-2">
              <button id="btn-sign-out" onClick={() => window.signOutSafe?.()} className="px-3 py-1.5 rounded-xl border dark:border-gray-700">Sign out</button>
              <span id="user-name" className="text-sm text-gray-600 dark:text-gray-300"></span>
            </div>
          </div>

          <div className="max-w-7xl mx-auto mb-4">
            <div className="inline-flex rounded-full border dark:border-gray-700 overflow-hidden">
              <button onClick={() => setTab('library')}
                className={clsx('px-4 py-2 text-sm', tab==='library' ? 'bg-black text-white' : 'bg-white dark:bg-gray-900')}>
                Library
              </button>
              <button onClick={() => setTab('navigator')}
                className={clsx('px-4 py-2 text-sm', tab==='navigator' ? 'bg-black text-white' : 'bg-white dark:bg-gray-900')}>
                Navigator
              </button>
            </div>
          </div>

          {tab === 'library' ? <LibraryView uid={uid} /> : <Navigator />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
